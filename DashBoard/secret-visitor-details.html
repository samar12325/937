<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تفاصيل ملاحظات الزائر السري</title>

  <!-- نقدر نعيد استخدام نفس CSS العام -->
  <link rel="stylesheet" href="secret-visitor.css"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- pdf -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
</head>

<body class="lang-ar" style="padding:24px;background:#f0f2f5;">
  <div id="exportArea" class="bg-white rounded-lg shadow p-6">
    <!-- التاريخ في الأعلى -->
         <div class="text-center mb-6">
       <h2 class="text-2xl font-bold text-gray-800 mb-2" data-ar="تقرير ملاحظات الزائر السري" data-en="Secret Visitor Report" id="reportTitle">تقرير ملاحظات الزائر السري</h2>
       <p class="text-lg text-gray-600" id="reportSubtitle"></p>
     </div>

         <div class="flex items-center justify-between mb-4" id="headerContainer">
       <h1 id="title" class="text-2xl font-bold text-gray-800">
         تفاصيل ملاحظات الزائر السري
       </h1>
               <div class="flex gap-2 items-center" id="buttonsContainer">
          <button id="exportBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded permission-gated" data-permission="reports_export" style="display: none;" data-ar="تصدير" data-en="Export">
            تصدير
          </button>
          <button id="langToggle" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 rounded border" data-ar="العربية | English" data-en="English | العربية">
            العربية | English
          </button>
          <button id="backBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded" data-ar="← رجوع" data-en="Back →">
            ← رجوع
          </button>
        </div>
     </div>

    <p id="summary" class="text-gray-600 mb-4"></p>

    <div class="overflow-auto">
             <table id="tbl" class="min-w-full text-sm border">
         <thead class="bg-gray-100">
           <tr>
             <th class="border px-3 py-2 text-right" data-ar="القسم" data-en="Department" id="deptHeader">القسم</th>
             <th class="border px-3 py-2 text-right" data-ar="الملاحظة" data-en="Note" id="noteHeader">الملاحظة</th>
             <th class="border px-3 py-2 text-right" data-ar="الإدارة المسؤولة" data-en="Responsible Department" id="respDeptHeader">الإدارة المسؤولة</th>
             <th class="border px-3 py-2 text-right" data-ar="حالة التنفيذ" data-en="Execution Status" id="statusHeader">حالة التنفيذ</th>
           </tr>
         </thead>
         <tbody id="tbody"></tbody>
       </table>
    </div>
  </div>

  <script>
    // ========= إعدادات لغة بسيطة =========
    let currentLang = localStorage.getItem('lang') || 'ar';
    const L = {
      title: { ar: 'تفاصيل ملاحظات الزائر السري', en: 'Secret Visitor Notes — Details' },
      deptPrefix: { ar: 'القسم: ', en: 'Department: ' },
      summary: { ar: 'عدد السجلات المطابقة: ', en: 'Matching records: ' },
      back: { ar: '← رجوع', en: 'Back →' },
      noInit: { ar: 'لا توجد بيانات بعد. استوردي ملفات Excel من لوحة الزائر السري ثم عودي هنا.', en: 'No data yet. Import the Excel files from the Secret Visitor dashboard then come back.' },
      noDeptMatch: { ar: 'لا توجد سجلات مطابقة للقسم المحدد.', en: 'No matching records for the selected department.' }
    };

    // ========= مصدر البيانات من صفحة الزائر السري =========
    const STORAGE_KEY = 'secret-visitor:data:v1'; // نفس المفتاح في secret-visitor.js
    const store = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    const rows  = Array.isArray(store.excelData) ? store.excelData : [];
    const reportDate = store.reportDate || ''; // قراءة تاريخ التقرير من localStorage
    
    console.log('Loaded data from storage:', rows);
    console.log('Report date from storage:', reportDate);

    // دالة تحويل التاريخ إلى الإنجليزية
    function convertDateToEnglish(arabicDate) {
        const monthMap = {
            'يناير': 'January',
            'فبراير': 'February', 
            'مارس': 'March',
            'أبريل': 'April',
            'مايو': 'May',
            'يونيو': 'June',
            'يوليو': 'July',
            'أغسطس': 'August',
            'سبتمبر': 'September',
            'أكتوبر': 'October',
            'نوفمبر': 'November',
            'ديسمبر': 'December'
        };
        
        // استخراج السنة والشهر من النص العربي
        const yearMatch = arabicDate.match(/سنة\s*(\d{4})/);
        const monthMatch = arabicDate.match(/شهر\s*(\w+)/);
        
        if (yearMatch && monthMatch) {
            const year = yearMatch[1];
            const arabicMonth = monthMatch[1];
            const englishMonth = monthMap[arabicMonth] || arabicMonth;
            return `For ${englishMonth} ${year}`;
        }
        
        return ''; // لا توجد قيمة افتراضية
    }

    // ========= قراءة الـ querystring =========
    const qs = new URLSearchParams(location.search);
    // نستقبل إما القيمة العربية للاسم أو الكود (dental-center …etc)
    const qsDepartment = qs.get('department') || localStorage.getItem('sv:selectedDepartment') || '';

    // ========= توحيد النص (عربي/إنجليزي) + مرادفات بسيطة =========
    const AR_DIAC = /[\u064B-\u0652]/g, TATWEEL=/\u0640/g;
    const norm = (s)=> String(s||'').replace(AR_DIAC,'').replace(TATWEEL,'').toLowerCase().trim().replace(/\s+/g,' ');

         // نفس القيم الموجودة في القائمة المنسدلة في secret-visitor.html
     const DEPT_MAP = {
       'dental-center': [/مركز الاسنان/, /اسنان/, /dental/],
       'emergency': [/طوارئ/, /emergency/],
       'corridors': [/ممرات/, /corridor/],
       'outpatient': [/عيادات خارجية|العيادات الخارجية|خارجية/, /outpatient/],
       'inpatient': [/تنويم/, /inpatient/]
     };
    
    // إضافة مرادفات للإدارات المسؤولة بناءً على الصورة المرفقة
    const RESPONSIBLE_DEPT_MAP = {
      'dental-center': [/مركز الاسنان/, /اسنان/, /dental/],
      'emergency': [/طوارئ/, /emergency/],
      'corridors': [/ممرات/, /corridor/],
      'outpatient': [/عيادات خارجية|العيادات الخارجية|خارجية/, /outpatient/],
      'inpatient': [/تنويم/, /inpatient/],
      'facilities': [/مرافق/, /facilities/],
      'nursing': [/تمريض/, /nursing/],
      'medical': [/طبي/, /medical/],
      'hr': [/موارد بشرية/, /human resources/],
      'patient-experience': [/تجربة مريض/, /patient experience/],
      'infection-control': [/مكافحة عدوى/, /infection control/],
      'preventive-health': [/صحة وقائية/, /preventive health/],
      'supply': [/تموين/, /supply/],
      'pharmacy': [/صيدلية/, /pharmacy/],
      'engineering': [/هندسية/, /engineering/],
      'projects': [/مشاريع/, /projects/]
    };

    function matchDepartment(rowDeptOrLoc, selected){
      if (!selected) return false;

      // إذا الممرَّر من الـ URL هو "نص عربي" خالص، نطابق مباشرة
      if (!DEPT_MAP[selected]) {
        return norm(rowDeptOrLoc).includes(norm(selected));
      }
      // إذا كان كود مثل dental-center .. نستخدم الأنماط
      return DEPT_MAP[selected].some(rx => rx.test(rowDeptOrLoc));
    }
    
    function matchResponsibleDepartment(responsibleDept, selected){
      if (!selected) return false;
      
      // إذا الممرَّر من الـ URL هو "نص عربي" خالص، نطابق مباشرة
      if (!RESPONSIBLE_DEPT_MAP[selected]) {
        return norm(responsibleDept).includes(norm(selected));
      }
      // إذا كان كود مثل dental-center .. نستخدم الأنماط
      return RESPONSIBLE_DEPT_MAP[selected].some(rx => rx.test(responsibleDept));
    }

         // ========= بناء الصفحة =========
     function build(){
       document.documentElement.lang = currentLang;
       document.body.dir = currentLang==='ar' ? 'rtl' : 'ltr';
       document.body.classList.remove('lang-ar','lang-en');
       document.body.classList.add(currentLang==='ar' ? 'lang-ar' : 'lang-en');

       // Update report title and subtitle
       const reportTitle = document.getElementById('reportTitle');
       const reportSubtitle = document.getElementById('reportSubtitle');
       if (reportTitle) {
         reportTitle.textContent = currentLang === 'ar' ? reportTitle.getAttribute('data-ar') : reportTitle.getAttribute('data-en');
       }
       if (reportSubtitle) {
         // استخدام التاريخ المستخرج من ملف الإكسل
         if (currentLang === 'en') {
           // تحويل التاريخ إلى الإنجليزية
           const englishDate = convertDateToEnglish(reportDate);
           reportSubtitle.textContent = englishDate;
         } else {
           reportSubtitle.textContent = reportDate;
         }
       }

               // Update table headers
        const deptHeader = document.getElementById('deptHeader');
        const noteHeader = document.getElementById('noteHeader');
        const respDeptHeader = document.getElementById('respDeptHeader');
        const statusHeader = document.getElementById('statusHeader');

                 if (deptHeader) {
           deptHeader.textContent = currentLang === 'ar' ? deptHeader.getAttribute('data-ar') : deptHeader.getAttribute('data-en');
           deptHeader.className = currentLang === 'ar' ? 'border px-3 py-2 text-right' : 'border px-3 py-2 text-left';
         }
         if (noteHeader) {
           noteHeader.textContent = currentLang === 'ar' ? noteHeader.getAttribute('data-ar') : noteHeader.getAttribute('data-en');
           noteHeader.className = currentLang === 'ar' ? 'border px-3 py-2 text-right' : 'border px-3 py-2 text-left';
         }
         if (respDeptHeader) {
           respDeptHeader.textContent = currentLang === 'ar' ? respDeptHeader.getAttribute('data-ar') : respDeptHeader.getAttribute('data-en');
           respDeptHeader.className = currentLang === 'ar' ? 'border px-3 py-2 text-right' : 'border px-3 py-2 text-left';
         }
         if (statusHeader) {
           statusHeader.textContent = currentLang === 'ar' ? statusHeader.getAttribute('data-ar') : statusHeader.getAttribute('data-en');
           statusHeader.className = currentLang === 'ar' ? 'border px-3 py-2 text-right' : 'border px-3 py-2 text-left';
         }

                 // Update button texts
         const exportBtn = document.getElementById('exportBtn');
         const langToggleBtn = document.getElementById('langToggle');
         const backBtn = document.getElementById('backBtn');
         
         if (exportBtn) {
           exportBtn.textContent = currentLang === 'ar' ? exportBtn.getAttribute('data-ar') : exportBtn.getAttribute('data-en');
         }
         if (langToggleBtn) {
           langToggleBtn.textContent = currentLang === 'ar' ? langToggleBtn.getAttribute('data-ar') : langToggleBtn.getAttribute('data-en');
         }
         if (backBtn) {
           backBtn.textContent = currentLang === 'ar' ? backBtn.getAttribute('data-ar') : backBtn.getAttribute('data-en');
         }

                   // Update header layout for LTR/RTL
          const headerContainer = document.getElementById('headerContainer');
          const title = document.getElementById('title');
          const buttonsContainer = document.getElementById('buttonsContainer');
          
          if (headerContainer && title && buttonsContainer) {
            if (currentLang === 'ar') {
              // RTL layout: title on left, buttons on right
              headerContainer.className = 'flex items-center justify-between mb-4';
              headerContainer.appendChild(title);
              headerContainer.appendChild(buttonsContainer);
            } else {
              // LTR layout: buttons on left, title on right
              headerContainer.className = 'flex items-center justify-between mb-4';
              headerContainer.appendChild(buttonsContainer);
              headerContainer.appendChild(title);
            }
            
            // Switch button order for English
            if (currentLang === 'en') {
              const backBtn = document.getElementById('backBtn');
              const exportBtn = document.getElementById('exportBtn');
              const langToggleBtn = document.getElementById('langToggle');
              
              if (backBtn && exportBtn && langToggleBtn) {
                // Clear and re-add buttons in new order: Back, Language Toggle, Export
                buttonsContainer.innerHTML = '';
                buttonsContainer.appendChild(backBtn);
                buttonsContainer.appendChild(langToggleBtn);
                buttonsContainer.appendChild(exportBtn);
              }
            } else {
              // Reset to original order for Arabic: Export, Language Toggle, Back
              const exportBtn = document.getElementById('exportBtn');
              const langToggleBtn = document.getElementById('langToggle');
              const backBtn = document.getElementById('backBtn');
              
              if (exportBtn && langToggleBtn && backBtn) {
                buttonsContainer.innerHTML = '';
                buttonsContainer.appendChild(exportBtn);
                buttonsContainer.appendChild(langToggleBtn);
                buttonsContainer.appendChild(backBtn);
              }
            }
          }

       // عنوان + خلاصة
       const titleParts = [];
       document.getElementById('title').textContent = (currentLang==='ar'?L.title.ar:L.title.en) + (titleParts.length?' — '+titleParts.join(' | '):'');

      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';

      if (!rows.length){
        // ما فيه بيانات أصلاً
                 const tr = document.createElement('tr');
         const td = document.createElement('td');
         td.colSpan = 4; td.className='border p-4 text-center text-gray-500';
         td.textContent = (currentLang==='ar'?L.noInit.ar:L.noInit.en);
         tr.appendChild(td); tbody.appendChild(tr);
        document.getElementById('summary').textContent = (currentLang==='ar'?L.summary.ar:L.summary.en) + '0';
        return;
      }

      // عرض البيانات من أول سطر في جدول الإكسل
      const firstRow = rows[0];
      
      console.log('Displaying first row from Excel data:', firstRow);
      
      if (!firstRow){
                 const tr = document.createElement('tr');
         const td = document.createElement('td');
         td.colSpan = 4; td.className='border p-4 text-center text-gray-500';
         td.textContent = (currentLang==='ar'?L.noDeptMatch.ar:L.noDeptMatch.en);
         tr.appendChild(td); tbody.appendChild(tr);
        document.getElementById('summary').textContent = (currentLang==='ar'?L.summary.ar:L.summary.en) + '0';
        return;
      }

                           // عرض السطر الأول
                 const tr = document.createElement('tr');
           const textAlign = currentLang === 'ar' ? 'text-right' : 'text-left'; // Right for Arabic, left for English
          
          // Debug: Log the row data to see what's being displayed
          console.log('Displaying first row in details:', {
            observationLocation: firstRow.observationLocation || firstRow.location,
            notes: firstRow.notes,
            notesType: typeof firstRow.notes,
            responsibleDepartment: firstRow.responsibleDepartment,
            status: firstRow.status
          });
          
          // Validate notes data
          if (!firstRow.notes || firstRow.notes === '—' || firstRow.notes === 'غير محدد') {
            console.warn(`⚠️ First row has empty or invalid notes: "${firstRow.notes}"`);
          } else {
            console.log(`✅ First row has valid notes: "${firstRow.notes}"`);
          }
          
          // Check if notes and location are the same (which would indicate a problem)
          if (firstRow.notes === (firstRow.observationLocation || firstRow.location)) {
            console.warn(`⚠️ Notes and location are the same: "${firstRow.notes}" - This might indicate a mapping issue`);
          }
          
          tr.innerHTML = `
            <td class="border px-3 py-2 ${textAlign}">${firstRow.observationLocation || firstRow.location || '—'}</td>
            <td class="border px-3 py-2 ${textAlign}">${firstRow.notes || '—'}</td>
            <td class="border px-3 py-2 ${textAlign}">${firstRow.responsibleDepartment || '—'}</td>
            <td class="border px-3 py-2 ${textAlign}">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${firstRow.status==='منفذ' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                ${firstRow.status || '—'}
              </span>
            </td>
          `;
          tbody.appendChild(tr);


      document.getElementById('summary').textContent =
        (currentLang==='ar'?L.summary.ar:L.summary.en) + '1';
    }

    // أزرار
    document.getElementById('backBtn').onclick = ()=> history.back();
    document.getElementById('langToggle').onclick = ()=>{
      currentLang = currentLang==='ar' ? 'en' : 'ar';
      localStorage.setItem('lang', currentLang);
      build();
    };

    // تصدير PDF
    document.getElementById('exportBtn').onclick = async ()=>{
      const root = document.getElementById('exportArea');
      const d = new Date(); const pad=n=>String(n).padStart(2,'0');
      const base = (currentLang==='ar'?'تفاصيل-الزائر-السري':'secret-visitor-details');
      const fileName = `${base}_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}.pdf`;
      const fullWidth = Math.max(root.scrollWidth, root.offsetWidth, root.clientWidth);
      await html2pdf().set({
        margin: [10,10,10,10],
        filename: fileName,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 3, useCORS: true, backgroundColor: '#ffffff', windowWidth: fullWidth },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' },
        pagebreak: { mode: ['avoid-all','css','legacy'] }
      }).from(root).save();
    };

    build();
  </script>
</body>
</html>