<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-ar="ูุคุดุฑ ุงูุชูุงุตู ุงููููู ููุญุฏุฉ ุงูุฏุนู ูุงููุณุงุนุฏุฉ ูุน ุงูุฃูุณุงู" data-en="Daily Communication Index for Support and Assistance Unit with Departments">ูุคุดุฑ ุงูุชูุงุตู ุงููููู ููุญุฏุฉ ุงูุฏุนู ูุงููุณุงุนุฏุฉ ูุน ุงูุฃูุณุงู</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Inter, Tajawal, and Merriweather -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Tajawal:wght@400;500;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <!-- Link to external CSS file -->
    <link rel="stylesheet" href="inperson-complaints.css">
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  @media print {
    @page { size: A4 landscape; margin: 10mm; }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  }
</style>

<body class="flex h-screen overflow-hidden lang-ar">

    <!-- Header Section -->
    <header class="header">
        <div class="header-content">
            <!-- Placeholder for hospital-logo.png -->
                    <div class="header-title" data-ar="ุจูุงุบุงุช 937" data-en="Reports 937">ุจูุงุบุงุช 937</div> 
                     <img src="/icon/hospital-logo.png" alt="ุดุนุงุฑ ุงููุณุชุดูู" class="header-logo">
  
            <button id="langToggle" class="lang-toggle-btn">
                <!-- Placeholder for lang.png -->
                <img src="/icon/lang.png" alt="language" class="lang-icon" />
                <span id="langText">ุงูุนุฑุจูุฉ | English</span>
            </button>
        </div>
    </header>

    <!-- Sidebar Section -->
    <aside>
        <ul class="sidebar-menu">
            <li><a href="/login/login.html" class="menu-link" data-ar="ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ" data-en="Home Page">ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ</a></li>
            <li><a href="overview.html" class="menu-link" data-ar="ูุธุฑุฉ ุนุงูุฉ" data-en="Overview">ูุธุฑุฉ ุนุงูุฉ</a></li>
            <li><a href="report-937.html" class="menu-link " data-ar="ูุคุดุฑ ุจูุงุบุงุช 937" data-en="937 Report Index">ูุคุดุฑ ุจูุงุบุงุช 937</a></li> <!-- Active link changed -->
            <li><a href="misconduct.html" class="menu-link" data-ar="ุจูุงุบุงุช ุณูุก ุงูุชุนุงูู" data-en="Misconduct Reports">ุจูุงุบุงุช ุณูุก ุงูุชุนุงูู</a></li>
            <li><a href="pressganey.html" class="menu-link" data-ar="ูุคุดุฑ ุจุฑุณุฌููู " data-en="Press Ganey Index">ูุคุดุฑ ุจุฑุณุฌููู </a></li>
            <li><a href="inperson-complaints.html" class="menu-link active" data-ar="ูุคุดุฑ ุงูุจูุงุบุงุช ุงูุญุถูุฑูุฉ" data-en="In-person Complaints">ูุคุดุฑ ุงูุจูุงุบุงุช ุงูุญุถูุฑูุฉ</a></li>
            <li><a href="secret-visitor.html" class="menu-link" data-ar="ููุงุญุธุงุช ุงูุฒุงุฆุฑ ุงูุณุฑู" data-en="Secret Visitor Notes">ููุงุญุธุงุช ุงูุฒุงุฆุฑ ุงูุณุฑู</a></li>
            <li><a href="general-requests.html" class="menu-link" data-ar="ูุคุดุฑ ุงูุทูุจุงุช ุงูุนุงูุฉ" data-en="General Requests Index">ูุคุดุฑ ุงูุทูุจุงุช ุงูุนุงูุฉ</a></li>
        </ul>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col p-8 overflow-auto" style="margin-right: 250px; margin-top: 75px;">
        <!-- Date Range Filter Section -->
        <div class="flex flex-wrap justify-end items-center gap-4 mb-8">
            <div class="flex items-center gap-2">
                <label for="dateFrom" class="text-gray-700 font-medium" data-ar="ูู ุชุงุฑูุฎ" data-en="From Date">ูู ุชุงุฑูุฎ</label>
                <input type="text" id="dateFrom" class="flatpickr-input" placeholder="ุงุฎุชุฑ ุงูุชุงุฑูุฎ" data-ar="ุงุฎุชุฑ ุงูุชุงุฑูุฎ" data-en="Select Date">
            </div>
            <div class="flex items-center gap-2">
                <label for="dateTo" class="text-gray-700 font-medium" data-ar="ุฅูู ุชุงุฑูุฎ" data-en="To Date">ุฅูู ุชุงุฑูุฎ</label>
                <input type="text" id="dateTo" class="flatpickr-input" placeholder="ุงุฎุชุฑ ุงูุชุงุฑูุฎ" data-ar="ุงุฎุชุฑ ุงูุชุงุฑูุฎ" data-en="Select Date">
            </div>
            <button id="applyFilterBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                <span data-ar="ุชุทุจูู ุงูููุชุฑุฉ" data-en="Apply Filter">ุชุทุจูู ุงูููุชุฑุฉ</span>
            </button>
        </div>

        <!-- Chart Section -->
        <div class="chart-container mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-6 text-center" data-ar="ุงูุจูุงุบุงุช ุงูุญุถูุฑูุฉ ุญุณุจ ููุน ุงูุจูุงุบ ูุงููุณู" data-en="In-person Complaints by Complaint Type and Department">ุงูุจูุงุบุงุช ุงูุญุถูุฑูุฉ ุญุณุจ ููุน ุงูุจูุงุบ ูุงููุณู</h2>
       
            <!-- Dynamic Legend Container -->
            <div id="legendContainer" class="flex flex-wrap justify-center gap-4 mb-6">
                <!-- ุณูุชู ููุก ูุฐุง ุงููุณู ุฏููุงููููุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช -->
            </div>
            
            <div class="relative w-full" style="height: 500px;">
                <canvas id="dailyCommunicationChart" style="width: 100%; height: 500px; max-width: 100%; max-height: 500px;"></canvas>
            </div>
        </div>

        <!-- Buttons for Export Report -->
        <div class="flex justify-center mt-8">
            <button id="exportReportBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg flex items-center permission-gated" data-permission="reports_export">
                <i class="fas fa-download ml-2"></i>
                <span data-ar="ุชุตุฏูุฑ ุงูุชูุฑูุฑ" data-en="Export Report">ุชุตุฏูุฑ ุงูุชูุฑูุฑ</span>
            </button>
            
            <!-- ุฒุฑ PDF ุงุญุชุฑุงูู -->
            <button id="exportInpersonPdfBtn" class="ml-3 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full shadow-lg flex items-center">
                <i class="fas fa-file-signature ml-2"></i>
                <span>ุชุตุฏูุฑ PDF </span>
            </button>
        </div>
    </div>
<script>
  (function () {
    // ุงุณุชุฎุฏูู ููุณ ุงูุชุฎุฒูู ุนูุฏู: localStorage.user ูุญุชูู RoleID
    function redirectByRole() {
      const user = JSON.parse(localStorage.getItem('user') || 'null');
      if (!user) return '/login/login.html';

      const roleId = Number(user.RoleID || user.roleId);
      if (roleId === 1) return '/superadmin/superadmin-home.html'; // ุณูุจุฑ ุฃุฏูู
      if (roleId === 2) return '/employee/employee-home.html';   // ููุธู
      if (roleId === 3) return '/dept-admin/dept-admin.html';      // ุฃุฏูู
      return '/login/login.html'; // ุงุญุชูุงุทู
    }

    // ูู ุฑูุงุจุท "ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ" ุงูููุฌูุฏุฉ ูู ุงูุดุฑูุท ุงูุฌุงูุจู
    const homeLinks = document.querySelectorAll(
      'aside .sidebar-menu a.menu-link[href$="/login/login.html"], aside .sidebar-menu a.menu-link[data-en="Home Page"], aside .sidebar-menu a.menu-link[data-ar="ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ"]'
    );

    homeLinks.forEach(a => {
      // ุฎูููู ุงูููุฑ ููุฌูู ุญุณุจ ุงูุฏูุฑ
      a.addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = redirectByRole();
      });

      // (ุงุฎุชูุงุฑู) ุนุฏููู ุงูู href ุงูุธุงูุฑ ููู Hover/Copy
      a.setAttribute('href', redirectByRole());
    });
  })();
</script>
    <!-- jsPDF for client-side PDF export -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <!-- Arabic shaping plugin for jsPDF -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf-arabic/dist/jspdf-arabic.min.js"></script>
    <!-- Link to external JavaScript file -->
    <script src="inperson-complaints.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Flatpickr Arabic locale -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>

<!-- jsPDF + html2canvas (ูุณุชุฎุฏูููุง ูุจุงุดุฑุฉ ุจุฏู html2pdf ูุชุฌููุจ ูุตู ุงูุนูุงุตุฑ) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log('๐ ุฑุจุท ุฒุฑ PDF...');
    const btn = document.getElementById('exportInpersonPdfBtn');
    
    if (!btn) {
      console.error('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฒุฑ PDF');
      return;
    }
    
    console.log('โ ุชู ุงูุนุซูุฑ ุนูู ุฒุฑ PDF');
    
    btn.addEventListener('click', async function() {
      console.log('๐ฑ๏ธ ุชู ุงูููุฑ ุนูู ุฒุฑ PDF');
      try {
        btn.disabled = true;
        const old = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i><span>ุฌุงุฑู ุงูุชุตุฏูุฑ...</span>';
        
        // ุงูุชุญูู ูู ูุฌูุฏ ุงูุฏุงูุฉ
        if (typeof exportInpersonPDF === 'function') {
          console.log('๐ ุจุฏุก ุชุตุฏูุฑ PDF...');
          await exportInpersonPDF();
          console.log('โ ุชู ุชุตุฏูุฑ PDF ุจูุฌุงุญ');
        } else {
          console.error('โ ุฏุงูุฉ exportInpersonPDF ุบูุฑ ููุฌูุฏุฉ');
          alert('ุฏุงูุฉ ุงูุชุตุฏูุฑ ุบูุฑ ูุชุงุญุฉ');
        }
        
        btn.innerHTML = old;
        btn.disabled = false;
      } catch (e) {
        console.error('โ ุฎุทุฃ ูู ุชุตุฏูุฑ PDF:', e);
        btn.innerHTML = old;
        btn.disabled = false;
        alert('ูุดู ูู ุชุตุฏูุฑ PDF: ' + e.message);
      }
    });
  });
</script>
</body>
</html>
