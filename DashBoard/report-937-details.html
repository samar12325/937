<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تفاصيل البلاغات حسب التصنيف/القسم</title>
  <link rel="stylesheet" href="report-937.css" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="lang-ar" style="padding:24px;background:#f0f2f5;">
  <div id="exportArea" class="bg-white rounded-lg shadow p-6">
    <div class="flex items-center justify-between mb-4">
      <h1 id="title" class="text-2xl font-bold text-gray-800">تفاصيل البلاغات</h1>
      <div class="flex gap-2 items-center">
        <button id="exportBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded permission-gated" data-permission="reports_export" style="display: none;">تصدير</button>
        <button id="langToggle" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 rounded border">العربية | English</button>
        <button id="backBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">← رجوع</button>
      </div>
    </div>
    <p id="summary" class="text-gray-600 mb-4"></p>

    <div class="overflow-auto">
      <table id="tbl" class="min-w-full text-sm border">
        <thead id="thead" class="bg-gray-100"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    let currentLang = localStorage.getItem('lang') || 'ar';
    const L = {
      title: { ar: 'تفاصيل البلاغات', en: 'Complaint Details' },
      catPrefix: { ar: 'تصنيف: ', en: 'Category: ' },
      deptPrefix: { ar: 'القسم: ', en: 'Department: ' },
      summary: { ar: 'عدد السجلات المطابقة: ', en: 'Matching records: ' },
      back: { ar: '← رجوع', en: '← Back' },
      noInit: { ar: 'لا توجد بيانات بعد. استوردي ملفات Excel من لوحة المؤشرات ثم عودي هنا.', en: 'No data yet. Import Excel files from the dashboard then come back.' },
      noDeptKey: { ar: 'تعذّر العثور على عمود القسم/الإدارة. تم البحث في جميع الأعمدة ولم نجد سجلات مطابقة.', en: 'Could not find the department/section column. Searched all columns with no matches.' },
      noDeptMatch: { ar: 'لا توجد سجلات مطابقة للقسم المحدد.', en: 'No matching records for the selected department.' },
      noCatKey: { ar: 'تعذّر العثور على عمود التصنيف في الملف.', en: 'Could not find the category column in the file.' },
      noGeneric: { ar: 'لا توجد سجلات مطابقة للفلتر الحالي.', en: 'No matching records for the current filter.' },
      desc: { ar: 'الوصف', en: 'Description' },
      category: { ar: 'التصنيف', en: 'Category' },
      department: { ar: 'الإدارة/القسم', en: 'Department/Section' },
      date: { ar: 'التاريخ', en: 'Date' }
    };

    const ROWS_KEY = 'report937:rows:v1';
    const SELECTED_CATEGORY_KEY = 'report937:selectedCategory';
    const SELECTED_CATEGORY_ALIASES_KEY = 'report937:selectedCategoryAliases';
    const SELECTED_DEPARTMENT_KEY = 'report937:selectedDepartment';
    const SELECTED_DEPARTMENT_ALIASES_KEY = 'report937:selectedDepartmentAliases';

    const AR_DIACRITICS = /[\u064B-\u0652]/g, AR_TATWEEL = /\u0640/g;
    function norm(s) { return String(s || '').replace(AR_DIACRITICS, '').replace(AR_TATWEEL, '').toLowerCase().trim().replace(/\s+/g, ' '); }

    const qs = new URLSearchParams(location.search);
    const qsCategory = qs.get('category') || '';
    const qsDepartment = qs.get('department') || '';

    const selectedCategory =
      localStorage.getItem(SELECTED_CATEGORY_KEY) ||
      localStorage.getItem('selectedCategory') ||
      qsCategory || '';

    const selectedCategoryAliases = JSON.parse(
      localStorage.getItem(SELECTED_CATEGORY_ALIASES_KEY) ||
      localStorage.getItem('selectedCategoryAliases') || '[]'
    );

    const selectedDepartment =
      localStorage.getItem(SELECTED_DEPARTMENT_KEY) || qsDepartment || '';

    const selectedDepartmentAliases = JSON.parse(
      localStorage.getItem(SELECTED_DEPARTMENT_ALIASES_KEY) || '[]'
    );

    function extraAliases(label) {
      const parts = String(label || '').split(/[\/|،,]/).map(s => s.trim()).filter(Boolean);
      return parts.length > 1 ? parts : [];
    }

    const rowsRaw = localStorage.getItem(ROWS_KEY);
    const rows = rowsRaw ? JSON.parse(rowsRaw) : [];

    const CAT_CANDS = ['تصنيف البلاغ', 'التصنيف', 'تصنيف', 'نوع البلاغ', 'category', 'complaint category', 'complaint type', 'type'];
    const DEPT_CANDS = ['القسم', 'الإدارة', 'الادارة', 'القسم/الإدارة', 'department', 'section', 'unit', 'dept'];

    function findKey(obj, candidates) {
      const keys = Object.keys(obj || {});
      for (const k of keys) { const nk = norm(k); if (candidates.some(c => nk.includes(norm(c)))) return k; }
      for (const k of keys) { const nk = norm(k); if (/(cat|type|نوع|تصنيف|classif|category)/.test(nk)) return k; }
      return null;
    }

    function build() {
      document.documentElement.lang = currentLang;
      document.body.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
      document.body.classList.remove('lang-ar', 'lang-en');
      document.body.classList.add(currentLang === 'ar' ? 'lang-ar' : 'lang-en');
      const langBtn = document.getElementById('langToggle');
      if (langBtn) langBtn.textContent = currentLang === 'ar' ? 'العربية | English' : 'English | العربية';

      const catNeedles = [selectedCategory, ...selectedCategoryAliases, ...extraAliases(selectedCategory)].map(norm).filter(Boolean);
      const deptNeedles = [selectedDepartment, ...selectedDepartmentAliases, ...extraAliases(selectedDepartment)].map(norm).filter(Boolean);

      const filtered = []; let catKey = null, deptKey = null;
      for (const r of rows) {
        if (!catKey) catKey = findKey(r, CAT_CANDS);
        if (!deptKey) deptKey = findKey(r, DEPT_CANDS);
        let ok = true;
        if (catNeedles.length){
          if (catKey){
            const hay = norm(r[catKey]);
            ok = ok && catNeedles.some(n => hay === n || hay.includes(n) || n.includes(hay));
          } else {
            const anyCell = Object.values(r).map(v => norm(v));
            ok = ok && catNeedles.some(n => anyCell.some(hay => hay.includes(n) || n.includes(hay)));
          }
        }
        if (ok && deptNeedles.length) {
          if (!deptKey) ok = false; else {
            const hay = norm(r[deptKey]);
            ok = ok && deptNeedles.some(n => hay === n || hay.includes(n) || n.includes(hay));
          }
        }
        if (ok) filtered.push(r);
      }

      const titleParts = [];
      if (selectedCategory) titleParts.push((currentLang==='ar'?L.catPrefix.ar:L.catPrefix.en) + selectedCategory);
      if (selectedDepartment) titleParts.push((currentLang==='ar'?L.deptPrefix.ar:L.deptPrefix.en) + selectedDepartment);
      document.getElementById('title').textContent = (currentLang==='ar'?L.title.ar:L.title.en) + (titleParts.length ? ' — ' + titleParts.join(' | ') : '');

      const summary = document.getElementById('summary');
      summary.textContent = (currentLang==='ar'?L.summary.ar:L.summary.en) + filtered.length;

      const thead = document.getElementById('thead'), tbody = document.getElementById('tbody');
      thead.innerHTML = ''; tbody.innerHTML = '';

      function empty(msg){
        const tr = document.createElement('tr'); const td = document.createElement('td');
        td.colSpan = 99; td.textContent = msg; td.className = 'border p-4 text-center text-gray-500';
        tr.appendChild(td); tbody.appendChild(tr);
      }

      if (!rows.length){
        document.getElementById('title').textContent = (currentLang==='ar'?L.title.ar:L.title.en);
        empty(currentLang==='ar'?L.noInit.ar:L.noInit.en); return;
      }

      if (!filtered.length){
        if (selectedDepartment && !rows.some(r => findKey(r, DEPT_CANDS))) {
          empty(currentLang==='ar'?L.noDeptKey.ar:L.noDeptKey.en);
        } else if (selectedDepartment) {
          empty(currentLang==='ar'?L.noDeptMatch.ar:L.noDeptMatch.en);
        } else if (selectedCategory && !rows.some(r => findKey(r, CAT_CANDS))) {
          empty(currentLang==='ar'?L.noCatKey.ar:L.noCatKey.en);
        } else {
          empty(currentLang==='ar'?L.noGeneric.ar:L.noGeneric.en);
        }
        return;
      }

      const cols = Object.keys(filtered[0]);
      const tr = document.createElement('tr');
      for (const c of cols) { const th = document.createElement('th'); th.textContent = c; th.className = 'border px-3 py-2 text-right'; tr.appendChild(th); }
      thead.appendChild(tr);

      filtered.forEach((row, i) => {
        const trb = document.createElement('tr');
        for (const c of cols) {
          const td = document.createElement('td');
          td.textContent = (row[c] == null ? '' : row[c]);
          td.className = 'border px-3 py-2';
          trb.appendChild(td);
        }
        tbody.appendChild(trb);
      });
    }

    document.getElementById('backBtn').onclick = () => history.back();
    document.getElementById('langToggle').onclick = () => {
      currentLang = currentLang === 'ar' ? 'en' : 'ar';
      localStorage.setItem('lang', currentLang);
      build();
    };

    // زر الرجوع بحسب اللغة عند البدء
    document.getElementById('backBtn').textContent = (currentLang==='ar'?L.back.ar:L.back.en);
    build();

    // ====== تصدير PDF مُنسّق ======
    function ensureHtml2Pdf(){
      if (window.html2pdf) return Promise.resolve(true);
      return new Promise((resolve)=>{
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js';
        s.onload = () => resolve(true);
        s.onerror = () => resolve(false);
        document.head.appendChild(s);
      });
    }
    function sanitizeName(s){ return String(s||'').replace(/[^\w\-\u0600-\u06FF]+/g,'-').replace(/-+/g,'-'); }
    async function exportAsPDF(){
      const ok = await ensureHtml2Pdf();
      if (!ok){ window.print(); return; }
      const root = document.getElementById('exportArea');
      if (!root){ window.print(); return; }
      const d = new Date(); const pad=n=>String(n).padStart(2,'0');
      const parts = [];
      if (typeof selectedCategory !== 'undefined' && selectedCategory) parts.push(selectedCategory);
      if (typeof selectedDepartment !== 'undefined' && selectedDepartment) parts.push(selectedDepartment);
      const base = parts.length ? parts.join('_') : (currentLang==='ar'?'تفاصيل-البلاغات':'complaint-details');
      const fileName = `${sanitizeName(base)}_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}.pdf`;
      const fullWidth = Math.max(root.scrollWidth, root.offsetWidth, root.clientWidth);
      await html2pdf().set({
        margin: [10,10,10,10],
        filename: fileName,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 3, useCORS: true, backgroundColor: '#ffffff', windowWidth: fullWidth },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' },
        pagebreak: { mode: ['avoid-all','css','legacy'], avoid: '.no-break' }
      }).from(root).save();
    }
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) exportBtn.onclick = exportAsPDF;
  </script>
</body>

</html>